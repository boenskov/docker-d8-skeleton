Скрипт для разворачивания контейнера с сайтом на Drupal 8 

Описание
========

Скрипт поднимает в docker-контейнере nginx, mysql, php7.0 и phpmyadmin. 

Контейнер занимает следующий порты:
*   80 - сам сайт
* 3306 - mysql
* 9999 - PMA

При необходимости изменить закрепленные порты надо поправить файл .env

Рутовый пароль для PMA и mysql - qwerty (можно поменять в docker-compose.yml)

Настройки БД для друпала (можно поменять в site):
* DB_DATABASE_NAME="site"
* DB_USER_NAME="user"
* DB_USER_PAS="qwerty"


Подготовка, установка, старт
============================

Для разворачивания контейнера необходимо:

1) установить git, docker, docker-compose:
-  `$ apt-get install git`
  
  docker (см. https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/)
  docker-compose  (см. https://docs.docker.com/compose/install/ )

  

- `sudo apt-get remove docker docker-engine docker.io` # удалим старую версию
- `sudo apt-get update`
- `sudo apt-get install apt-transport-https ca-certificates curl software-properties-common`
- `curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -`
- `apt-get update`
- `apt-get install docker.io docker-compose`

  PS. возможна установка docker и docker-compose из репозитариев, но необходимо удостовериться, что  
  версия docker-compose 1.6.0 или выше, а docker-engine - 1.10.0 или выше (в репозитарии могут лежать
  старые версии).

  Создадим группу докера и добавим туда юзера. Это 
  необходимо для возможности запуска докера не от суперюзера
    
- `sudo groupadd docker`
- `sudo usermod -aG docker $USER`
    
  Проверим, что докер работает (скорее-всего надо будет перезагрузить комп)
            
- `docker run hello-world`


  
  Также необходимо убедиться, что к репозитарию есть корректный доступ по ssh с использование ключа


  
  Основным скриптом для управления будет 'site.sh' и иногда может потребоваться docker или docker-compose...

2) `./site.sh prepare`
    Подготовим необходимую структуру папок
    
3) `./site.sh clone` (отключено)
    Склонируем в папку /var/www/site исходный код проекта 
    
4) `./site.sh add_config`
    Сгенерируем файл settings.php с параметрами доступа к БД, описанием путей для врапперов и прочих настроек D8
    
5) `./site.sh start`
  Запустим контейнер. При первом запуске начнется сборка контейнеров и это может занять некоторое время.
  По окончании сборки, если все прошло успешно, должен появиться список запущенных контейнеров. Если всё прошло 
  успешно, то будет запущено 4 контейнера, если нет, то надо смотреть логи и решать проблему.
  
  Чтобы проверить, что контейнеры работают надо перейти по адресу 0.0.0.0 и там увидеть страницу Друпала
  с сообщением об ошибке в конфигах или подключения к СУБД
  
6) `./site.sh mysql_init` (отключено)
  Создание БД и пользователей для проекта. Проверить, что нет сообщений об ошибках
  
7)  Развернуть бекап. Для этого (отключено) 
  - сначала скопируем в папку init_sql бекап с расширением .sql 
  - затем войдем в контейнер: `docker exec -it docker__mysql_1 bash` (вместо xxdocker надо поставить 
    идентификатор проекта, если он отличается) Подсказка пути измениться на что-то типа "root@3a387eecd1f8:/# " 
  - перейти в папку /init_sql (`cd /init_sql`)
  - войти в mysql (`mysql -pqwerty site`)
  - выполнить `source имя_бекапа.sql`
  - выйти из mysql (`exit`)
  - выйти из bash (`exit`)
  
После этих действий сайт должен стать работоспособным.


Работа с контейнерами
=====================

Войти в контейнер:
* `./site.sh nginx`
* `./site.sh fpm`
* `./site.sh mysql`

Если необходимо запустить `drush`, то входим в контейнер fpm, переходим в папку /var/www/site и используем drush 

Подключение xDebug
==================

Каких либо сложных дополнительных манипуляций не требуется
* Жмем кнопку Start Listening
* Settings - Languages & Frameworks - PHP - Debug
* Validate в п1
* Указываем Local Webserver и url http://127.0.0.1

Увидим все пункты отмеченны галками, если нет ошибок 

Для использования профайлера необходимо добавить в строку GET запроса строку "?XDEBUG_PROFILE". Результаты работы профайлера можно найти в папке profiler в папке этого репозитария